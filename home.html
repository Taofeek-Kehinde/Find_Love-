<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindLove - Home</title>
    <link rel="shortcut icon" href="Icon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #ff4b8b;
            --secondary: #ff87ab;
            --dark: #3a0c3f;
            --light: #fff9fb;
            --accent: #a83279;
            --success: #4caf50;
            --warning: #ff9800;
            --gray: #f0f0f0;
            --text: #333333;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #fff9fb 0%, #ffeef4 100%);
            color: var(--text);
            min-height: 100vh;
        }

        /* Main Container */
        .main-container {
            display: flex;
            min-height: 100vh;
        }

        /* Left Sidebar - User Profile */
        .left-sidebar {
            width: 300px;
            background: var(--white);
            box-shadow: 2px 0 10px var(--shadow);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--gray);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            font-size: 1.2rem;
            transition: all 0.3s;
            display: none; /* Hidden by default */
        }

        .sidebar-close:hover {
            background: var(--primary);
            color: white;
        }

        /* Show close button only on mobile/small devices */
        @media (max-width: 768px) {
            .sidebar-close {
                display: flex;
            }
        }

        .profile-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 15px;
            border: 4px solid white;
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .menu-items {
            list-style: none;
        }

        .menu-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .menu-item:hover {
            background: var(--gray);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: var(--primary);
            color: white;
        }

        .menu-item i {
            font-size: 1.2rem;
            width: 20px;
        }

        .notification-badge {
            position: absolute;
            right: 10px;
            text-align: center;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 300px;
            padding: 20px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--white);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            background: var(--white);
            box-shadow: 0 2px 5px var(--shadow);
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: var(--primary);
            margin: 3px 0;
            transition: 0.3s;
        }

        .hamburger.open span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.open span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        .content-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* Users Grid */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 280px);
            gap: 20px;
            margin-bottom: 30px;
        }

        .user-card {
            background: var(--white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow);
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            width: 280px;
            height: auto;
        }

        .user-info {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 75, 139, 0.2);
        }

        .user-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            position: relative;
        }

        .online-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            background: var(--success);
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-info {
            padding: 20px;
        }

        .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .user-details {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .user-interests {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .interest-tag {
            background: var(--light);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            border: 1px solid var(--primary);
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .like-btn {
            background: var(--primary);
            color: white;
        }

        .like-btn:hover {
            background: var(--accent);
        }

        .message-btn {
            background: var(--gray);
            color: var(--dark);
        }

        .message-btn:hover {
            background: var(--dark);
            color: white;
        }

        /* No Users Message */
        .no-users {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .no-users i {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .no-users h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        /* Custom Alert Modal */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .custom-alert-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .custom-alert {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.7);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .custom-alert-overlay.show .custom-alert {
            transform: scale(1);
        }

        .custom-alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }

        .custom-alert-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: bounce 0.6s ease;
        }

        .custom-alert-icon.success { color: #28a745; }
        .custom-alert-icon.error { color: #dc3545; }
        .custom-alert-icon.warning { color: #ffc107; }
        .custom-alert-icon.info { color: #17a2b8; }

        .custom-alert-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .custom-alert-message {
            font-size: 1rem;
            color: #666;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .custom-alert-button {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .custom-alert-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 75, 139, 0.3);
        }

        /* Animations */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            background: var(--white);
            box-shadow: 0 2px 5px var(--shadow);
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: var(--primary);
            margin: 3px 0;
            transition: 0.3s;
        }

        .hamburger.open span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.open span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .left-sidebar {
                width: 250px;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .left-sidebar.open {
                transform: translateX(0);
            }

            .left-sidebar.open ~ .main-content .content-header {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }

            .hamburger {
                display: flex;
            }

            .content-header {
                padding: 15px;
            }

            .content-title {
                font-size: 1.8rem;
            }

            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }

            .profile-name {
                font-size: 1.1rem;
            }

            .menu-item {
                padding: 12px;
            }

            .users-grid {
                grid-template-columns: repeat(auto-fill, 250px);
                gap: 15px;
            }

            .user-card {
                width: 250px;
                height: 450px;
            }

            .user-image {
                height: 180px;
            }

            .user-info {
                padding: 15px;
                overflow-y: auto;
            }

            .user-name {
                font-size: 1.1rem;
            }

            .user-details {
                font-size: 0.85rem;
            }

            .action-btn {
                padding: 8px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 640px) {
            .left-sidebar {
                width: 280px;
            }

            .main-content {
                padding: 15px;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .content-title {
                font-size: 1.5rem;
            }

            #searchInput {
                width: 200px !important;
            }

            .users-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .user-card {
                margin: 0 auto;
                max-width: 100%;
                height: auto;
            }

            .user-info {
                padding: 15px;
            }

            .user-interests {
                flex-wrap: wrap;
                gap: 3px;
            }

            .interest-tag {
                font-size: 0.75rem;
                padding: 3px 6px;
            }

            .user-actions {
                flex-direction: column;
                gap: 8px;
            }

            .action-btn {
                width: 100%;
                padding: 10px;
            }

            .no-users {
                padding: 40px 15px;
            }

            .no-users i {
                font-size: 3rem;
            }

            .no-users h3 {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }

            .content-header {
                padding: 10px;
            }

            .content-title {
                font-size: 1.3rem;
            }

            #searchInput {
                width: 150px !important;
                padding: 8px 35px 8px 12px;
            }

            .profile-card {
                padding: 15px;
            }

            .profile-avatar {
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }

            .profile-name {
                font-size: 1rem;
            }

            .profile-details {
                font-size: 0.8rem;
            }

            .menu-item {
                padding: 10px;
                font-size: 0.9rem;
            }

            .menu-item i {
                font-size: 1.1rem;
                width: 18px;
            }

            .user-card {
                border-radius: 10px;
                height: 450px;
            }

            .user-image {
                height: 150px;
                font-size: 2.5rem;
            }

            .user-info {
                padding: 8px;
                overflow: hidden;
            }

            .user-name {
                font-size: 1rem;
                margin-bottom: 3px;
            }

            .user-details {
                font-size: 0.8rem;
                margin-bottom: 8px;
            }

            .user-interests {
                gap: 2px;
                margin-bottom: 10px;
            }

            .interest-tag {
                font-size: 0.7rem;
                padding: 2px 5px;
            }

            .user-actions {
                gap: 4px;
            }

            .action-btn {
                padding: 6px;
                font-size: 0.8rem;
            }

            .no-users {
                padding: 30px 10px;
            }

            .no-users i {
                font-size: 2.5rem;
            }

            .no-users h3 {
                font-size: 1.1rem;
            }

            .no-users p {
                font-size: 0.9rem;
            }

            .custom-alert {
                max-width: 90%;
                padding: 20px;
            }

            .custom-alert-title {
                font-size: 1.3rem;
            }

            .custom-alert-message {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar - User Profile -->
        <aside class="left-sidebar">
            <div class="sidebar-close" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </div>
            <div class="profile-card">
                <div class="profile-cover" id="profileCover" style="width:100%;height:120px;background:#eee;border-radius:15px 15px 0 0;overflow:hidden;margin-bottom: -50px;position:relative;">
                    <!-- Cover image will be set by JS -->
                </div>
                <div class="profile-avatar" id="profileAvatar" style="width:120px;height:120px;position:relative;z-index:2;margin:0 auto 10px;top:-60px;box-shadow:0 4px 20px rgba(0,0,0,0.1);background:#fff;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-name" id="profileName">Loading...</div>
                <div class="profile-details" id="profileDetails">Loading...</div>
            </div>

            <ul class="menu-items">
                <li class="menu-item active" onclick="showSection('matches')">
                    <i class="fas fa-heart"></i>
                    <span>My Matches</span>
                </li>
                <li class="menu-item" onclick="window.location.href='chat.html'">
                    <i class="fas fa-comments"></i>
                    <span>Messages</span>
                    <span class="notification-badge" id="messageCount" style="display: none;">0</span>
                </li>
                <li class="menu-item" onclick="showSection('friends')">
                    <i class="fas fa-user-friends"></i>
                    <span>Friends</span>
                </li>
                <li class="menu-item" onclick="showSection('notifications')">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </li>

                <li class="menu-item" onclick="showSection('account')">
                    <i class="fas fa-user-cog"></i>
                    <span>Account Settings</span>
                </li>
                <li class="menu-item" onclick="showSection('help')">
                    <i class="fas fa-life-ring"></i>
                    <span>Help & Support</span>
                </li>
                <li class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="hamburger" onclick="toggleSidebar()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <h1 class="content-title" id="sectionTitle">My Matches</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="position: relative;">
                        <input type="text" id="searchInput" placeholder="Search people..."
                               style="padding: 10px 40px 10px 15px; border: 2px solid var(--gray); border-radius: 25px; outline: none; width: 250px;"
                               oninput="searchUsers()">
                        <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary);"></i>
                    </div>
                    <i class="fas fa-heart" style="color: var(--primary); font-size: 1.5rem;"></i>
                </div>
            </div>

            <!-- Users Grid -->
            <div class="users-grid" id="usersGrid">
                <!-- Users will be loaded here -->
            </div>

            <!-- No Users Message -->
            <div class="no-users" id="noUsersMessage" style="display: none;">
                <i class="fas fa-users"></i>
                <h3>No Users Found</h3>
                <p>There are no other users available right now. Check back later!</p>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let allUsers = [];
        let friendsList = [];
        let friendsMap = new Map();

        // Load friends list
        async function loadFriends() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const userId = currentUser?.id || currentUser?._id;
                if (!userId) return;
                const response = await fetch(`http://localhost:3001/api/friends/${userId}`);
                const data = await response.json();
                if (data.success) {
                    friendsList = data.friends;
                    friendsMap = new Map(friendsList.map(f => [f.id || f._id || f.email, f]));
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        // Check if user is authenticated
        function checkAuth() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            try {
                currentUser = JSON.parse(user);
            } catch (e) {
                window.location.href = 'index.html';
                return;
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadFriends().then(() => {
                loadUsers();
            });
            updateMessageCount();
            updateNotificationCount();
            startRealTimeUpdates();

            // Check if profile is completed
            if (!currentUser.profileCompleted) {
                window.location.href = 'profile-setup.html';
                return;
            }

            // Fetch latest user profile information
            fetchCurrentUserProfile();
        });

        // Fetch current user profile from server
        async function fetchCurrentUserProfile() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = user?.id || user?._id || user?.email;
                if (!userId) return;

                const response = await fetch(`http://localhost:3001/api/user/${userId}?requestingUserId=${userId}`);
                if (!response.ok) {
                    console.warn('Failed to fetch current user profile:', response.status);
                    return;
                }
                const data = await response.json();
                if (data.success && data.user) {
                    const updatedUser = { ...user, ...data.user };
                    localStorage.setItem('user', JSON.stringify(updatedUser));
                    currentUser = updatedUser;
                    loadCurrentUser();
                }
            } catch (error) {
                console.error('Error fetching current user profile:', error);
            }
        }

        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Load current user profile
        function loadCurrentUser() {
            if (!currentUser) return;

            // Update profile name
            const profileNameEl = document.getElementById('profileName');
            if (profileNameEl) {
                profileNameEl.textContent = currentUser.fullName || 'User';
            }

            // Update profile details
            const profileDetailsEl = document.getElementById('profileDetails');
            if (profileDetailsEl) {
                const dob = currentUser.dateOfBirth ? new Date(currentUser.dateOfBirth).toLocaleDateString() : 'Not set';
                const gender = currentUser.gender ? capitalizeFirstLetter(currentUser.gender) : 'Gender not set';
                const location = currentUser.location || 'Location not set';
                const bio = currentUser.bio || '';
                profileDetailsEl.innerHTML = `
                    <div style="margin-bottom: 5px;"><strong>Date of Birth:</strong> ${dob}</div>
                    <div style="margin-bottom: 5px;"><strong>Gender:</strong> ${gender}</div>
                    <div style="margin-bottom: 5px;"><strong>Address:</strong> ${location}</div>
                    ${bio ? `<div style="margin-bottom: 5px;"><strong>Bio:</strong> ${bio}</div>` : ''}
                `;
            }

            // Update profile avatar (large)
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileAvatar) {
                if (currentUser.profilePic) {
                    profileAvatar.innerHTML = `<img src="${currentUser.profilePic}" alt="Profile" style="width: 120px; height: 120px; object-fit: cover; border-radius: 50%;">`;
                } else {
                    profileAvatar.innerHTML = `<i class="fas fa-user" style="font-size: 3rem; color: var(--primary);"></i>`;
                }
            }

            // Update cover picture if available
            const coverPicEl = document.getElementById('profileCover');
            if (coverPicEl) {
                if (currentUser.coverPic) {
                    coverPicEl.style.backgroundImage = `url(${currentUser.coverPic})`;
                    coverPicEl.style.backgroundSize = 'cover';
                    coverPicEl.style.backgroundPosition = 'center';
                } else {
                    coverPicEl.style.background = '#eee';
                }
            }
        }

        // Calculate age from date of birth
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/A';

            const today = new Date();
            const birthDate = new Date(dateOfBirth);

            if (isNaN(birthDate.getTime())) return 'N/A';

            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            return age > 0 ? age : 'N/A';
        }

        // Load all users from database
        async function loadUsers() {
            try {
                const response = await fetch('http://localhost:3001/api/users');
                const data = await response.json();
                if (data.success) {
                    // Filter out the current user from allUsers
                    allUsers = data.users.filter(user => {
                        const userId = user.id || user._id || user.email;
                        const currentUserId = currentUser?.id || currentUser?._id || currentUser?.email;
                        return userId !== currentUserId;
                    });
                    displayUsers(allUsers);
                } else {
                    console.error('Failed to load users:', data.message);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Display users in grid
        function displayUsers(users) {
            const usersGrid = document.getElementById('usersGrid');
            const noUsersMessage = document.getElementById('noUsersMessage');

            if (users.length === 0) {
                usersGrid.style.display = 'none';
                noUsersMessage.style.display = 'block';
                return;
            }

            usersGrid.style.display = 'grid';
            noUsersMessage.style.display = 'none';

            usersGrid.innerHTML = users.map(user => {
                const userId = user.id || user._id || user.email;
                const matchPct = computeMatchPercentage(currentUser || {}, user);
                const hobby = getMainHobby(user);
                const country = extractCountry(user.location);
                let ageStr = calculateAge(user.dateOfBirth);
                let ageDisplay = '';
                if (ageStr !== 'N/A') {
                    ageDisplay = `${ageStr} years old • `;
                }
                const gender = user.gender ? String(user.gender).charAt(0).toUpperCase() + String(user.gender).slice(1) : '';
                return `
                <div class="user-card" onclick="viewUserProfile('${userId}')">
                    <div class="user-image">
                        ${user.profilePic ?
                            `<img src="${user.profilePic}" alt="${user.fullName}" style="width: 100%; height: 100%; object-fit: cover;">` :
                            `<img src="Images/s2.png" alt="${user.fullName}" style="width: 100%; height: 100%; object-fit: cover;">`
                        }
                        <div class="online-status" style="display: ${user.isOnline ? 'block' : 'none'};"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name">${user.fullName}</div>
                        <div class="user-details">
                            ${ageDisplay}${gender ? `${gender} • ` : ''}${country}
                            ${hobby ? ` • Hobby: ${hobby}` : ''}
                        </div>
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 10px;">${matchPct}% Match</div>
                        ${user.bio ? `<div style="font-size: 0.9rem; color: #666; margin: 10px 0; line-height: 1.4;">${user.bio.substring(0, 100)}${user.bio.length > 100 ? '...' : ''}</div>` : ''}
                        <div class="user-interests">
                            ${(user.interests || '').split(',').map(interest =>
                                `<span class="interest-tag">${interest.trim()}</span>`
                            ).join('')}
                        </div>
                        <div class="user-actions">
                            <button class="action-btn like-btn" id="fr-btn-${userId}" onclick="event.stopPropagation(); toggleFriendRequest('${userId}')">
                                <i class="fas fa-user-plus"></i> Add Friend
                            </button>
                            <button class="action-btn message-btn" onclick="event.stopPropagation(); startChat('${userId}')">
                                <i class="fas fa-comment"></i> Message
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // After render, update friend-request button states (persist across reloads)
            Promise.all(users.map(user => updateFriendButtonState(user.id || user._id || user.email))).catch(() => {});
        }

        // Extract a primary hobby from interests string
        function getMainHobby(user) {
            const interests = (user.interests || '').split(',').map(i => i.trim()).filter(Boolean);
            return interests.length > 0 ? interests[0] : '';
        }

        // Extract country from a free-form location string
        function extractCountry(location) {
            if (!location) return 'Location not set';
            const parts = String(location).split(',').map(p => p.trim()).filter(Boolean);
            return parts.length ? parts[parts.length - 1] : location;
        }

        // Compute a simple match percentage based on overlapping interests and same country
        function computeMatchPercentage(baseUser, otherUser) {
            const baseInterests = ((baseUser.interests || '') + '').split(',').map(i => i.trim().toLowerCase()).filter(Boolean);
            const otherInterests = ((otherUser.interests || '') + '').split(',').map(i => i.trim().toLowerCase()).filter(Boolean);
            let score = 0;
            if (baseInterests.length && otherInterests.length) {
                const set = new Set(baseInterests);
                const overlap = otherInterests.filter(i => set.has(i)).length;
                const max = Math.max(baseInterests.length, otherInterests.length);
                if (max > 0) score += Math.round((overlap / max) * 80); // up to 80% from interests
            }
            const countryA = extractCountry(baseUser.location || '').toLowerCase();
            const countryB = extractCountry(otherUser.location || '').toLowerCase();
            if (countryA && countryB && countryA === countryB) score += 15; // same country bonus
            // small randomness to feel organic
            score += 5;
            return Math.max(50, Math.min(99, score));
        }

        // Search users functionality
        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (searchTerm === '') {
                displayUsers(allUsers);
                return;
            }

            const filteredUsers = allUsers.filter(user =>
                user.fullName.toLowerCase().includes(searchTerm) ||
                (user.location && user.location.toLowerCase().includes(searchTerm)) ||
                (user.bio && user.bio.toLowerCase().includes(searchTerm)) ||
                (user.interests && user.interests.toLowerCase().includes(searchTerm))
            );

            displayUsers(filteredUsers);
        }

        // Show no users message
        function showNoUsers() {
            document.getElementById('usersGrid').style.display = 'none';
            document.getElementById('noUsersMessage').style.display = 'block';
        }

        // Add friend from card
        async function addFriend(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const fromUserId = currentUser?.id || currentUser?._id;
                if (!fromUserId) {
                    showCustomAlert('Error', 'Please log in to add friends', 'error');
                    return;
                }
                // Prevent sending friend request to self
                if (userId === fromUserId) {
                    showCustomAlert('Error', 'You cannot send a friend request to yourself', 'error');
                    return;
                }
                const response = await fetch('http://localhost:3001/api/friend-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fromUserId, toUserId: userId })
                });
                const data = await response.json();
                if (data.success) {
                    showCustomAlert('Friend Request Sent', 'They will need to accept before you can chat.', 'success');
                    setFriendButtonState(userId, 'pending');
                } else {
                    showCustomAlert('Error', data.message || 'Could not send friend request', 'error');
                }
            } catch (e) {
                showCustomAlert('Error', 'Network error sending friend request', 'error');
            }
        }

        async function cancelFriendRequest(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const fromUserId = currentUser?.id || currentUser?._id;
                const resp = await fetch('http://localhost:3001/api/friendship-status/' + fromUserId + '/' + userId);
                const st = await resp.json();
                const response = await fetch('http://localhost:3001/api/friend-request/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requestId: st.requestId, fromUserId, toUserId: userId })
                });
                const data = await response.json();
                if (data.success) {
                    setFriendButtonState(userId, 'none');
                } else {
                    showCustomAlert('Error', data.message || 'Unable to cancel request', 'error');
                }
            } catch (e) {
                showCustomAlert('Error', 'Network error canceling request', 'error');
            }
        }

        async function toggleFriendRequest(userId) {
            const btn = document.getElementById('fr-btn-' + userId);
            if (!btn) return;

            // Prevent sending friend request to self
            const currentUser = JSON.parse(localStorage.getItem('user'));
            const fromUserId = currentUser?.id || currentUser?._id;
            if (userId === fromUserId) {
                showCustomAlert('Error', 'You cannot send a friend request to yourself', 'error');
                return;
            }

            if (btn.getAttribute('data-state') === 'pending') {
                await cancelFriendRequest(userId);
            } else {
                await addFriend(userId);
            }
        }

        async function acceptFriendRequest(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const toUserId = currentUser?.id || currentUser?._id;
                if (!toUserId) {
                    showCustomAlert('Error', 'Please log in to accept friend requests', 'error');
                    return;
                }
                const response = await fetch('http://localhost:3001/api/friend-request/respond', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fromUserId: userId, toUserId, action: 'accept' })
                });
                const data = await response.json();
                if (data.success) {
                    showCustomAlert('Friend Request Accepted', 'You are now friends! You can start chatting.', 'success');
                    setFriendButtonState(userId, 'accepted');
                    loadFriends(); // Reload friends list to update the friends section
                } else {
                    showCustomAlert('Error', data.message || 'Could not accept friend request', 'error');
                }
            } catch (e) {
                showCustomAlert('Error', 'Network error accepting friend request', 'error');
            }
        }

        async function declineFriendRequest(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const toUserId = currentUser?.id || currentUser?._id;
                if (!toUserId) {
                    showCustomAlert('Error', 'Please log in to decline friend requests', 'error');
                    return;
                }
                const response = await fetch('http://localhost:3001/api/friend-request/respond', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fromUserId: userId, toUserId, action: 'decline' })
                });
                const data = await response.json();
                if (data.success) {
                    showCustomAlert('Friend Request Declined', 'The friend request has been declined.', 'info');
                    setFriendButtonState(userId, 'none');
                } else {
                    showCustomAlert('Error', data.message || 'Could not decline friend request', 'error');
                }
            } catch (e) {
                showCustomAlert('Error', 'Network error declining friend request', 'error');
            }
        }

        async function updateFriendButtonState(otherUserId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const myId = currentUser?.id || currentUser?._id || currentUser?.email;
                const resp = await fetch(`http://localhost:3001/api/friendship-status/${myId}/${otherUserId}`);
                const data = await resp.json();
                if (data.success) {
                    setFriendButtonState(otherUserId, data.status, data.role);
                }
            } catch {}
        }

        function setFriendButtonState(userId, status, role) {
            const btn = document.getElementById('fr-btn-' + userId);
            if (!btn) return;

            // Remove any existing accept/decline buttons for this user
            const existingAcceptBtn = document.getElementById('accept-btn-' + userId);
            const existingDeclineBtn = document.getElementById('decline-btn-' + userId);
            if (existingAcceptBtn) existingAcceptBtn.remove();
            if (existingDeclineBtn) existingDeclineBtn.remove();

            if (status === 'pending') {
                if (role === 'sender') {
                    btn.innerHTML = '<i class="fas fa-trash"></i> Delete Request';
                    btn.setAttribute('data-state', 'pending');
                    btn.classList.remove('like-btn');
                    btn.classList.add('message-btn');
                    btn.disabled = false;
                } else if (role === 'receiver') {
                    // For receiver, show Accept and Decline buttons
                    btn.style.display = 'none'; // Hide the original button

                    // Create Accept button
                    const acceptBtn = document.createElement('button');
                    acceptBtn.id = 'accept-btn-' + userId;
                    acceptBtn.className = 'action-btn like-btn';
                    acceptBtn.style.flex = '1';
                    acceptBtn.innerHTML = '<i class="fas fa-check"></i> Accept';
                    acceptBtn.onclick = (e) => {
                        e.stopPropagation();
                        acceptFriendRequest(userId);
                    };

                    // Create Decline button
                    const declineBtn = document.createElement('button');
                    declineBtn.id = 'decline-btn-' + userId;
                    declineBtn.className = 'action-btn message-btn';
                    declineBtn.style.flex = '1';
                    declineBtn.innerHTML = '<i class="fas fa-times"></i> Decline';
                    declineBtn.onclick = (e) => {
                        e.stopPropagation();
                        declineFriendRequest(userId);
                    };

                    // Insert buttons after the original button
                    btn.parentNode.insertBefore(acceptBtn, btn.nextSibling);
                    btn.parentNode.insertBefore(declineBtn, acceptBtn.nextSibling);
                } else {
                    btn.innerHTML = '<i class="fas fa-hourglass-half"></i> Pending';
                    btn.setAttribute('data-state', 'pending');
                    btn.disabled = true;
                    btn.classList.remove('like-btn');
                    btn.classList.remove('message-btn');
                }
            } else if (status === 'accepted') {
                btn.style.display = 'block'; // Make sure it's visible
                btn.innerHTML = '<i class="fas fa-user-check"></i> Friends';
                btn.setAttribute('data-state', 'accepted');
                btn.disabled = true;
            } else {
                btn.style.display = 'block'; // Make sure it's visible
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Add Friend';
                btn.setAttribute('data-state', 'none');
                btn.disabled = false;
                btn.classList.add('like-btn');
                btn.classList.remove('message-btn');
            }
        }

        // Start chat with user
        function startChat(userId) {
            console.log('Starting chat with user:', userId);
            if (!userId) {
                alert('Invalid user ID');
                return;
            }
            // Redirect to chat page
            window.location.href = `chat.html?userId=${userId}`;
        }

        // View user profile
        function viewUserProfile(userId) {
            console.log('Viewing profile:', userId);
            // Find user and show profile modal
            const user = allUsers.find(u => u._id === userId);
            if (user) {
                showUserProfileModal(user);
            }
        }



        // Show user profile modal
        function showUserProfileModal(user) {
            const userId = user.id || user._id || user.email;
            const modal = document.createElement('div');
            modal.className = 'custom-alert-overlay';
            modal.innerHTML = `
                <div class="custom-alert" style="max-width: 500px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; overflow: hidden;">
                            ${user.profilePic ?
                                `<img src="${user.profilePic}" alt="${user.fullName}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                `<i class="fas fa-user"></i>`
                            }
                        </div>
                        <h2 style="color: var(--dark); margin-bottom: 5px;">${user.fullName}</h2>
                        <p style="color: #666;">${calculateAge(user.dateOfBirth) === 'N/A' ? 'Age not set' : calculateAge(user.dateOfBirth) + ' years old'} • ${user.gender}</p>
                        ${user.location ? `<p style="color: #666; margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${user.location}</p>` : ''}
                    </div>

                    ${user.bio ? `<div style="text-align: left; margin-bottom: 20px; padding: 15px; background: var(--light); border-radius: 10px;">
                        <h4 style="color: var(--dark); margin-bottom: 10px;">About</h4>
                        <p style="color: #666; line-height: 1.5;">${user.bio}</p>
                    </div>` : ''}

                    ${user.interests ? `<div style="text-align: left; margin-bottom: 20px;">
                        <h4 style="color: var(--dark); margin-bottom: 10px;">Interests</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${user.interests.split(',').map(interest =>
                                `<span style="background: var(--light); color: var(--primary); padding: 4px 8px; border-radius: 15px; font-size: 0.8rem; border: 1px solid var(--primary);">${interest.trim()}</span>`
                            ).join('')}
                        </div>
                    </div>` : ''}

                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="likeUser('${userId}'); closeCustomAlert();" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-heart"></i> Like
                        </button>
                        <button onclick="startChat('${userId}'); closeCustomAlert();" style="flex: 1; padding: 12px; background: var(--gray); color: var(--dark); border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-comment"></i> Message
                        </button>
                    </div>

                    <button onclick="closeCustomAlert()" style="margin-top: 15px; background: transparent; border: 1px solid var(--gray); color: var(--text); padding: 8px 20px; border-radius: 20px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // Show section
        function showSection(section) {
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');

            // Update section title and content
            const titles = {
                'matches': 'My Matches',
                'friends': 'Friends',
                'messages': 'Messages',
                'notifications': 'Notifications',
                'account': 'Account Settings',
                'help': 'Help & Support'
            };

            document.getElementById('sectionTitle').textContent = titles[section] || 'FindLove';

            // Show different content based on section
            const usersGrid = document.getElementById('usersGrid');
            const noUsersMessage = document.getElementById('noUsersMessage');

            if (section === 'matches') {
                usersGrid.style.display = 'grid';
                noUsersMessage.style.display = 'none';
                // Filter out friends from matches
                const filteredMatches = allUsers.filter(user => !friendsMap.has(user.id || user._id || user.email));
                const ranked = [...filteredMatches].sort((a,b) => computeMatchPercentage(currentUser||{}, b) - computeMatchPercentage(currentUser||{}, a));
                displayUsers(ranked);
                return;
            }
            if (section === 'friends') {
                usersGrid.style.display = 'grid';
                noUsersMessage.style.display = 'none';
                displayUsers(friendsList);
                return;
            }
            if (section === 'messages') {
                usersGrid.style.display = 'none';
                noUsersMessage.style.display = 'block';
                loadConversations();
                return;
            }
            if (section === 'notifications') {
                usersGrid.style.display = 'none';
                noUsersMessage.style.display = 'block';
                loadNotifications();
                return;
            }
            if (section === 'account') {
                window.location.href = 'account-settings.html';
                return;
            }
            if (section === 'help') {
                window.location.href = 'contact.html';
                return;
            }
        }

        // Update message count badge
        async function updateMessageCount() {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            const userId = currentUser?.id || currentUser?._id;
            if (!userId) return;

            try {
                const response = await fetch(`http://localhost:3001/api/conversations/${userId}`);
                const data = await response.json();
                if (data.success) {
                    const unreadTotal = data.conversations.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
                    const messageBadge = document.getElementById('messageCount');
                    if (unreadTotal > 0) {
                        messageBadge.textContent = unreadTotal;
                        messageBadge.style.display = 'inline';
                    } else {
                        messageBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating message count:', error);
            }
        }

        // Update notification count badge
        async function updateNotificationCount() {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            const userId = currentUser?.id || currentUser?._id;
            if (!userId) return;

            try {
                const response = await fetch(`http://localhost:3001/api/notifications/${userId}`);
                const data = await response.json();
                if (data.success) {
                    const unreadCount = data.notifications.filter(n => !n.read).length;
                    const notificationBadge = document.getElementById('notificationCount');
                    if (unreadCount > 0) {
                        notificationBadge.textContent = unreadCount;
                        notificationBadge.style.display = 'inline';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating notification count:', error);
            }
        }

        // Load conversations
        async function loadConversations() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const userId = currentUser?.id || currentUser?._id;

                if (!userId) {
                    document.getElementById('noUsersMessage').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-comments" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                            <h3 style="color: var(--dark); margin-bottom: 10px;">Messages</h3>
                            <p style="color: #666;">Please log in to view messages.</p>
                        </div>
                    `;
                    return;
                }

                const response = await fetch(`http://localhost:3001/api/conversations/${userId}`);
                const data = await response.json();

                if (data.success && data.conversations.length > 0) {
                    const conversationsHtml = data.conversations.map(conversation => {
                        const otherUser = conversation.participants.find(p => p._id !== userId);
                        const lastMessage = conversation.lastMessage || {};
                        const unreadCount = conversation.unreadCount || 0;
                        return `
                        <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; border-left: 4px solid var(--primary);" onclick="startChat('${otherUser._id}')">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                    ${otherUser.profilePic ?
                                        `<img src="${otherUser.profilePic}" alt="${otherUser.fullName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` :
                                        `<i class="fas fa-user"></i>`
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <p style="margin: 0; color: var(--dark); font-weight: 600;">${otherUser.fullName}</p>
                                        <small style="color: #666;">${formatConversationTime(lastMessage.timestamp)}</small>
                                    </div>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">${lastMessage.content || 'No messages yet'}</p>
                                </div>
                                ${unreadCount > 0 ? `<div style="width: 20px; height: 20px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 600;">${unreadCount}</div>` : ''}
                            </div>
                        </div>
                        `;
                    }).join('');

                    document.getElementById('noUsersMessage').innerHTML = `
                        <div style="text-align: left; padding: 20px;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <i class="fas fa-comments" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                <h3 style="color: var(--dark); margin-bottom: 5px;">Messages</h3>
                                <p style="color: #666;">You have ${data.conversations.length} conversation${data.conversations.length > 1 ? 's' : ''}</p>
                            </div>
                            ${conversationsHtml}
                        </div>
                    `;

                } else {
                    document.getElementById('noUsersMessage').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-comments" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                            <h3 style="color: var(--dark); margin-bottom: 10px;">No Messages</h3>
                            <p style="color: #666;">You don't have any conversations yet. Start chatting with someone!</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('noUsersMessage').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4757; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">Error Loading Messages</h3>
                        <p style="color: #666;">Unable to load messages. Please check your connection.</p>
                    </div>
                `;
            }
        }

        // Format conversation time
        function formatConversationTime(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const time = new Date(timestamp);
            const diffInMinutes = Math.floor((now - time) / (1000 * 60));

            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            return `${Math.floor(diffInMinutes / 1440)}d ago`;
        }

        // Show contact form
        function showContactForm() {
            showCustomAlert('Contact Support', 'Support contact form coming soon! You can reach us at support@findlove.com', 'info');
        }

        // Custom Alert System
        function showCustomAlert(title, message, type = 'info', callback = null) {
            const existingAlert = document.querySelector('.custom-alert-overlay');
            if (existingAlert) {
                existingAlert.remove();
            }

            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';

            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-times-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'info':
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
            }

            overlay.innerHTML = `
                <div class="custom-alert">
                    <div class="custom-alert-icon ${type}">
                        ${icon}
                    </div>
                    <div class="custom-alert-title">${title}</div>
                    <div class="custom-alert-message">${message}</div>
                    <button class="custom-alert-button" onclick="closeCustomAlert()">
                        OK
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);

            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);

            if (callback) {
                overlay.setAttribute('data-callback', callback.toString());
            }
        }

        function closeCustomAlert() {
            const overlay = document.querySelector('.custom-alert-overlay');
            if (overlay) {
                const callback = overlay.getAttribute('data-callback');
                overlay.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    if (callback) {
                        eval(callback)();
                    }
                }, 300);
            }
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.left-sidebar');
            const hamburger = document.querySelector('.hamburger');
            sidebar.classList.toggle('open');
            hamburger.classList.toggle('open');
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            // Refresh users every 30 seconds
            setInterval(() => { loadUsers(); updateMessageCount(); }, 30000);
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const userId = currentUser?.id || currentUser?._id;

                if (!userId) {
                    document.getElementById('noUsersMessage').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-bell" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                            <h3 style="color: var(--dark); margin-bottom: 10px;">Notifications</h3>
                            <p style="color: #666;">Please log in to view notifications.</p>
                        </div>
                    `;
                    return;
                }

                const response = await fetch(`http://localhost:3001/api/notifications/${userId}`);
                const data = await response.json();

                if (data.success && data.notifications.length > 0) {
                    const notificationsHtml = data.notifications.map(notification => `
                        <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid var(--primary);">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-heart" style="color: var(--primary); font-size: 1.2rem;"></i>
                                <div style="flex: 1;">
                                    <p style="margin: 0; color: var(--dark); font-weight: 500;">${notification.message}</p>
                                    <small style="color: #666;">${formatNotificationTime(notification.timestamp)}</small>
                                </div>
                                ${!notification.read ? '<div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%;"></div>' : ''}
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('noUsersMessage').innerHTML = `
                        <div style="text-align: left; padding: 20px;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <i class="fas fa-bell" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                <h3 style="color: var(--dark); margin-bottom: 5px;">Notifications</h3>
                                <p style="color: #666;">You have ${data.notifications.length} notification${data.notifications.length > 1 ? 's' : ''}</p>
                            </div>
                            ${notificationsHtml}
                        </div>
                    `;

                    // Update notification count
                    const unreadCount = data.notifications.filter(n => !n.read).length;
                    const notificationBadge = document.getElementById('notificationCount');
                    if (unreadCount > 0) {
                        notificationBadge.textContent = unreadCount;
                        notificationBadge.style.display = 'inline';
                    } else {
                        notificationBadge.style.display = 'none';
                    }

                } else {
                    document.getElementById('noUsersMessage').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-bell" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                            <h3 style="color: var(--dark); margin-bottom: 10px;">No Notifications</h3>
                            <p style="color: #666;">You don't have any notifications yet. When someone likes your profile, you'll see it here!</p>
                        </div>
                    `;
                    document.getElementById('notificationCount').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('noUsersMessage').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4757; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">Error Loading Notifications</h3>
                        <p style="color: #666;">Unable to load notifications. Please check your connection.</p>
                    </div>
                `;
            }
        }

        // Format notification time
        function formatNotificationTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInMinutes = Math.floor((now - time) / (1000 * 60));

            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            return `${Math.floor(diffInMinutes / 1440)}d ago`;
        }

        // Like user profile
        async function likeUser(userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                const fromUserId = currentUser?.id || currentUser?._id;
                const fromUserName = currentUser?.fullName || 'Someone';

                if (!fromUserId) {
                    showCustomAlert('Error', 'Please log in to like profiles', 'error');
                    return;
                }

                // Send like notification
                const response = await fetch('http://localhost:3001/api/send-like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fromUserId, toUserId: userId, fromUserName })
                });

                const data = await response.json();

                if (data.success) {
                    showCustomAlert('Profile Liked!', 'Your like has been sent successfully 💕', 'success');
                } else {
                    showCustomAlert('Error', data.message || 'Could not send like', 'error');
                }
            } catch (error) {
                console.error('Error liking user:', error);
                showCustomAlert('Error', 'Network error sending like', 'error');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>